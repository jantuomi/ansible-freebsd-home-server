- name: Set up network interfaces
  community.general.sysrc:
    name: "{{ item.name }}"
    value: "{{ item.value | default(omit) }}"
    state: "{{ item.state | default(omit) }}"
  loop:
    - { name: "ifconfig_igc0", state: "absent" }
    - { name: "ifconfig_igc1", state: "absent" }
    - { name: "ifconfig_igc0_name", value: "lan0" }
    - { name: "ifconfig_igc1_name", value: "wan0" }
    - { name: "ifconfig_lan0", value: "DHCP" }
    - { name: "ifconfig_wan0", value: "DHCP" }
    - { name: "ifconfig_lan0_ipv6", value: "inet6 accept_rtadv" }
    - { name: "ifconfig_wan0_ipv6", value: "inet6 accept_rtadv" }
  register: ifconfig_sysrc

- name: Restart networking if interface configuration changed
  shell: service netif restart
  when: ifconfig_sysrc.changed

- name: Update facts
  setup:

- name: Set up sshd
  template:
    src: etc_ssh_sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: wheel
    mode: "0644"
  register: etc_sshd_config

- name: Restart sshd
  service:
    name: sshd
    state: restarted
  when: etc_sshd_config.changed

- name: Disable syslogd remote listening
  community.general.sysrc:
    name: syslogd_flags
    value: "-s"
  register: syslogd_flags

- name: Enable syslogd
  service:
    name: syslogd
    enabled: true

- name: Restart syslogd
  service:
    name: syslogd
    state: restarted
  when: syslogd_flags.changed

- name: Configure pf
  template:
    src: etc_pf.conf.j2
    dest: /etc/pf.conf
    owner: root
    group: wheel
    mode: "0644"
    backup: yes
  register: pf_conf

- name: Enable and start pf
  service:
    name: pf
    enabled: true
    state: started

- name: Reload pf rules
  shell: pfctl -f /etc/pf.conf
  when: pf_conf.changed

- name: Install nginx
  package:
    name: nginx
    state: present

- name: Configure nginx.conf
  template:
    src: usr_local_etc_nginx_nginx.conf.j2
    dest: /usr/local/etc/nginx/nginx.conf
    owner: root
    group: wheel
    mode: "0644"
  register: nginx_conf

- name: Enable nginx
  service:
    name: nginx
    enabled: true

- name: Restart nginx
  service:
    name: nginx
    state: restarted
  when: nginx_conf.changed
