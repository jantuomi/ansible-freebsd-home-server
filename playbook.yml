---
- name: Configure my FreeBSD home server
  hosts: pursotin

  pre_tasks:
    - name: Fail if direnv wasn't loaded and SMTP_USER is missing
      assert:
        that:
          - lookup('env', 'SMTP_USER') != ''
        fail_msg: >
          Required environment variables are missing. Did you forget to run `direnv allow` or load `.envrc`?
      vars:
        ansible_assert_no_log: true

  vars:
    smtp_user: "{{ lookup('env', 'SMTP_USER') }}"
    smtp_password: "{{ lookup('env', 'SMTP_PASSWORD') }}"
    smtp_host: "{{ lookup('env', 'SMTP_HOST') }}"
    smtp_port: "{{ lookup('env', 'SMTP_PORT') }}"
    dma_mail_hostname: "{{ lookup('env', 'DMA_MAILNAME') }}"
    dma_to_address: "{{ lookup('env', 'DMA_TO_ADDRESS') }}"
    jails:
      - { name: nginx_test, ip: "192.168.2.1" }

  tasks:
    - name: Run network tasks
      import_tasks: tasks/network.yml

    - name: Run email tasks
      import_tasks: tasks/email.yml

    - name: Run ZFS tasks
      import_tasks: tasks/zfs.yml

    - name: Run jails tasks
      import_tasks: tasks/jails.yml
