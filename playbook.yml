---
- name: Configure my FreeBSD home server
  hosts: pursotin

  pre_tasks:
    - name: Fail if secrets.yml wasn't loaded and smtp_user is missing
      assert:
        that:
          - smtp_user != ''
        fail_msg: >
          Required variables are missing. Did you forget to create a secrets.yml file?
      vars:
        ansible_assert_no_log: true

  vars_files:
    - secrets.yml
  vars:
    lan_ipv4_cidr: 192.168.0.10/16
    lan_ipv4_gateway: 192.168.0.1
    lan_search_domain: local.jan.systems
    jail_userland_version: 14.3-RELEASE
    jail_ingress_ip: "192.168.2.1"
    jails:
      - { name: ingress, num: 1, tls: false }
      - { name: postgres, num: 2, tls: false }
      - { name: irc_thelounge, num: 3, tls: false }
      - { name: taulubot, num: 4, tls: false }
      - { name: homepage, num: 5, tls: false }
      - { name: hommabot, num: 6, tls: false }
      - { name: aggro, num: 7, tls: true, host: aggro.jan.systems }
      - { name: diddle, num: 8, tls: true, host: diddle.jan.systems }
      #- { name: gallery_sakari, num: 9, tls: false }
      #- { name: gallery_leo, num: 10, tls: false }
      - { name: spliit, num: 11, tls: true, host: spliit.jan.systems }
      #- { name: stirling-pdf, num: 12, tls: false }
      - { name: ente, num: 13, tls: false }
      - { name: freshrss, num: 14, tls: true, host: freshrss.jan.systems }
    static_sites:
      - { site: "homepage", host: "jan.systems", tls: true }
    static_site_dirs:
      homepage: "{{ jan_systems_html_dir }}"

  tasks:
    - name: Run general tasks
      tags: [general]
      import_tasks: tasks/general.yml

    - name: Run network tasks
      tags: [network]
      import_tasks: tasks/network.yml

    - name: Run email tasks
      tags: [email]
      import_tasks: tasks/email.yml

    - name: Run ZFS tasks
      tags: [zfs]
      import_tasks: tasks/zfs.yml

    - name: Run common jails tasks
      tags: [jails]
      import_tasks: tasks/jails.yml

    - name: Run ingress jail tasks
      tags: [jail_ingress]
      import_tasks: tasks/jail_ingress.yml

    - name: Run postgres jail tasks
      tags: [jail_postgres]
      import_tasks: tasks/jail_postgres.yml

    - name: Run diddle jail tasks
      tags: [jail_diddle]
      import_tasks: tasks/jail_diddle.yml

    - name: Run hommabot jail tasks
      tags: [jail_hommabot]
      import_tasks: tasks/jail_hommabot.yml

    - name: Run jail homepage tasks
      tags: [jail_homepage]
      import_tasks: tasks/jail_homepage.yml
